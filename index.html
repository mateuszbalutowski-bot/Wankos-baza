<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Wankos Intel Panel</title>

  <style>
    :root{
      --bg:#0b0f17;
      --panel:#111827;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#60a5fa;
      --accent2:#34d399;
      --warn:#fbbf24;
      --danger:#fb7185;
      --ok:#22c55e;
      --border:rgba(255,255,255,0.07);
      --shadow: 0 12px 50px rgba(0,0,0,0.4);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", Arial;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 900px at 15% 10%, rgba(96,165,250,0.16), transparent 60%),
                  radial-gradient(1200px 900px at 90% 40%, rgba(52,211,153,0.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    header{
      padding:18px 18px;
      border-bottom:1px solid var(--border);
      background:rgba(17,24,39,0.6);
      backdrop-filter: blur(8px);
      position:sticky;
      top:0;
      z-index:10;
    }

    .wrap{ max-width:1200px; margin:0 auto; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:18px;
      flex-wrap:wrap;
    }

    h1{
      margin:0;
      font-size:16px;
      letter-spacing:0.2px;
      font-weight:800;
    }

    .subtitle{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      line-height:1.3;
    }

    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .tab{
      cursor:pointer;
      padding:9px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(2,6,23,0.35);
      color: var(--muted);
      font-weight:800;
      font-size:12px;
      user-select:none;
      transition:.15s;
    }

    .tab:hover{ filter:brightness(1.08); transform: translateY(-1px); }

    .tab.active{
      color: #0b1220;
      border-color: rgba(96,165,250,0.35);
      background: linear-gradient(180deg, rgba(96,165,250,1), rgba(59,130,246,1));
    }

    main{ padding:20px 18px 80px; }

    .card{
      background: linear-gradient(180deg, rgba(17,24,39,0.95), rgba(15,23,42,0.95));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      overflow:hidden;
      margin-bottom:16px;
    }

    .card h2{
      margin:0;
      font-size:13px;
      font-weight:900;
      letter-spacing:0.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .hint{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }

    textarea, input{
      width:100%;
      background: rgba(2,6,23,0.55);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      color:var(--text);
      font-size:13px;
      outline:none;
      transition:0.15s;
      font-family:var(--sans);
    }

    textarea{
      min-height:160px;
      resize:vertical;
      font-family:var(--mono);
      line-height:1.35;
      font-size:12px;
      margin-top:12px;
    }

    textarea:focus, input:focus{
      border-color: rgba(96,165,250,0.5);
      box-shadow:0 0 0 4px rgba(96,165,250,0.12);
    }

    button{
      border:none;
      cursor:pointer;
      border-radius:12px;
      padding:10px 14px;
      font-weight:900;
      font-size:12px;
      transition:0.15s;
      display:inline-flex;
      align-items:center;
      gap:8px;
      color:#0b1220;
      background: linear-gradient(180deg, rgba(96,165,250,1), rgba(59,130,246,1));
    }

    button:hover{ transform: translateY(-1px); filter:brightness(1.05); }
    button:active{ transform: translateY(0px); filter:brightness(0.98); }

    .btn2{
      background: linear-gradient(180deg, rgba(52,211,153,1), rgba(16,185,129,1));
    }

    .btnDanger{
      background: linear-gradient(180deg, rgba(251,113,133,1), rgba(244,63,94,1));
    }

    .btnGhost{
      background: rgba(15,23,42,0.8);
      border:1px solid var(--border);
      color:var(--text);
    }

    .row{
      display:flex;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
      align-items:center;
    }

    .mono{ font-family:var(--mono); }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:11px;
      color:var(--muted);
      background: rgba(2,6,23,0.4);
      user-select:none;
      font-weight:900;
    }

    .tag.green{ color:rgba(34,197,94,0.95); border-color: rgba(34,197,94,0.25); }
    .tag.red{ color:rgba(251,113,133,0.95); border-color: rgba(251,113,133,0.25); }
    .tag.yellow{ color:rgba(251,191,36,0.95); border-color: rgba(251,191,36,0.25); }
    .tag.blue{ color:rgba(96,165,250,0.95); border-color: rgba(96,165,250,0.25); }

    .divider{
      height:1px;
      background: var(--border);
      margin: 14px 0;
    }

    .listBox{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(2,6,23,0.35);
      overflow:hidden;
    }

    .item{
      padding:12px 12px;
      border-bottom:1px solid var(--border);
      transition:.12s;
    }

    .item:last-child{ border-bottom:none; }

    .inline{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      flex-wrap:wrap;
    }

    .small{
      font-size:11px;
      color:var(--muted);
      line-height:1.4;
    }

    .toast{
      position: fixed;
      bottom: 20px;
      right: 20px;
      max-width: 360px;
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(17,24,39,0.95);
      box-shadow: var(--shadow);
      color: var(--text);
      font-size: 12px;
      display:none;
      z-index:999;
    }
    .toast strong{
      display:block;
      margin-bottom:6px;
      font-size:12px;
    }

    .clickSource{
      cursor:pointer;
      color: rgba(96,165,250,0.95);
      text-decoration: underline;
    }
    .clickSource:hover{
      filter: brightness(1.2);
    }

    .clickPlayer{
      cursor:pointer;
      color: rgba(52,211,153,0.95);
      text-decoration: underline;
    }
    .clickPlayer:hover{
      filter: brightness(1.2);
    }
  </style>
</head>

<body>

<header>
  <div class="wrap topbar">
    <div>
      <h1>Wankos Intel Panel</h1>
      <div class="subtitle">
        Panel plemienny do analizy atak√≥w + baza token√≥w OFF/DEFF.
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="login">Logowanie</div>
      <div class="tab" data-tab="labels">Etykiety Atak√≥w</div>
      <div class="tab" data-tab="analysis">Analiza</div>
      <div class="tab" data-tab="enemydb">Baza Wroga</div>
      <div class="tab" data-tab="settings">Ustawienia</div>
    </div>
  </div>
</header>

<main id="appMain" style="display:none;">
  <div class="wrap">

    <!-- LOGIN TAB -->
    <div class="tabPanel" id="tab-login">
      <div class="card">
        <h2>
          üîê Logowanie
          <span id="loginStatus" class="tag red">NIEZALOGOWANY</span>
        </h2>

        <div class="hint">
          Rejestracja wymaga kodu plemienia. Kod nie jest publiczny i nie wy≈õwietla siƒô na stronie.
        </div>

        <div class="divider"></div>

        <h2>üÜï Rejestracja</h2>
        <div class="row">
          <input id="regNick" placeholder="Nick z gry..." />
          <input id="regPass" type="password" placeholder="Has≈Ço..." />
          <input id="regCode" placeholder="Kod plemienia..." />
          <button id="btnRegister" class="btn2">Za≈Ç√≥≈º konto</button>
        </div>

        <div class="divider"></div>

        <h2>üîë Logowanie</h2>
        <div class="row">
          <input id="loginNick" placeholder="Nick..." />
          <input id="loginPass" type="password" placeholder="Has≈Ço..." />
          <button id="btnLogin" class="btn2">Zaloguj</button>
          <button id="btnLogout" class="btnDanger">Wyloguj</button>
        </div>

      </div>
    </div>

    <!-- LABELS TAB -->
    <div class="tabPanel" id="tab-labels" style="display:none;">
      <div class="card">
        <h2>
          üè∑Ô∏è Etykiety Atak√≥w
          <span class="tag blue">Tribe DB</span>
        </h2>

        <div class="hint">
          Wklej swoje etykiety z gry. System:
          <br>‚úÖ zapisze je w bazie plemienia
          <br>‚úÖ przypisze defender do Twojego konta
        </div>

        <textarea id="labelsInput" placeholder="Wklej etykiety atak√≥w tutaj..."></textarea>

        <div class="row">
          <button id="btnUploadLabels" class="btn2">üì• Wy≈õlij etykiety</button>
          <button id="btnClearLabels" class="btnGhost">üßπ Wyczy≈õƒá</button>
        </div>

        <div class="divider"></div>

        <h2>üìå Podsumowanie</h2>
        <div id="labelsSummary" class="listBox">
          <div class="item small">Brak danych.</div>
        </div>
      </div>
    </div>

    <!-- ANALYSIS TAB -->
    <div class="tabPanel" id="tab-analysis" style="display:none;">
      <div class="card">
        <h2>
          üìä Analiza atak√≥w (Twoje wioski)
          <span class="tag yellow">Threat Engine</span>
        </h2>

        <div class="hint">
          Pokazuje tylko Twoje wioski (defender), ale powtarzalno≈õƒá ≈∫r√≥de≈Ç liczona jest z ca≈Çej bazy plemienia.
          <br>Kliknij ≈∫r√≥d≈Ço aby przej≈õƒá do bazy token√≥w.
        </div>

        <div class="row">
          <button id="btnRunAnalysis" class="btn2">‚ö° Przelicz analizƒô</button>
        </div>

        <div id="threatBoard" class="listBox">
          <div class="item small">Brak danych. Wklej etykiety w zak≈Çadce "Etykiety Atak√≥w".</div>
        </div>
      </div>
    </div>

    <!-- ENEMY DB TAB -->
    <div class="tabPanel" id="tab-enemydb" style="display:none;">
      <div class="card">
        <h2>
          üè∞ Baza Wiosek Wroga (tokeny)
          <span class="tag green">Supabase</span>
        </h2>

        <div class="hint">
          Tokeny OFF/DEFF mo≈ºe dodawaƒá tylko admin. U≈ºytkownicy mogƒÖ tylko przeglƒÖdaƒá.
        </div>

        <div id="enemyDbBox" class="listBox">
          <div class="item small">Brak danych.</div>
        </div>

        <div class="divider"></div>

        <div id="adminTokenPanel" style="display:none;">
          <h2>‚ûï Dodaj tokeny (ADMIN)</h2>
          <textarea id="tokenInput" placeholder="Wklej tokeny HN1/HN2 tutaj..."></textarea>
          <div class="row">
            <button id="btnUploadTokens" class="btn2">üì• Dodaj tokeny</button>
          </div>
        </div>

      </div>
    </div>

    <!-- SETTINGS TAB -->
    <div class="tabPanel" id="tab-settings" style="display:none;">
      <div class="card">
        <h2>
          ‚öôÔ∏è Ustawienia
          <span id="adminTag" class="tag red">USER</span>
        </h2>

        <div class="hint">
          U≈ºytkownik mo≈ºe usuwaƒá swoje etykiety. Admin mo≈ºe zarzƒÖdzaƒá u≈ºytkownikami i tokenami.
        </div>

        <div class="divider"></div>

        <h2>üßπ Moje dane</h2>
        <div class="row">
          <button id="btnDeleteMyLabels" class="btnDanger">Usu≈Ñ moje etykiety</button>
        </div>

        <div class="divider"></div>

        <h2>üëë Panel admina</h2>
        <div id="adminPanel" class="listBox">
          <div class="item small">Brak dostƒôpu.</div>
        </div>

      </div>
    </div>

  </div>
</main>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ===================== SUPABASE CONFIG ===================== */
const SUPABASE_URL = "https://cixrktawkfxaexhzhnho.supabase.co";
const SUPABASE_KEY = "sb_publishable_kUYmC66z6c9g3qrj0hx2Zg_ZV__s0zA";

const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===================== UTIL ===================== */
function toast(title, msg){
  const t = document.getElementById("toast");
  t.innerHTML = `<strong>${escapeHtml(title)}</strong>${escapeHtml(msg)}`;
  t.style.display = "block";
  setTimeout(()=>{ t.style.display="none"; }, 3200);
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
/* ===================== UI LOCK ===================== */
function lockUI(){
  document.getElementById("appMain").style.display = "block";

  document.querySelectorAll(".tab").forEach(t=>{
    const name = t.getAttribute("data-tab");
    if(name === "login"){
      t.style.display = "inline-flex";
    }else{
      t.style.display = "none";
    }
  });

  switchTab("login");
}

function unlockUI(){
  document.getElementById("appMain").style.display = "block";

  document.querySelectorAll(".tab").forEach(t=>{
    t.style.display = "inline-flex";
  });
}

/* ===================== TABS ===================== */
function switchTab(name){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tabPanel").forEach(p=>p.style.display="none");

  document.querySelector(`.tab[data-tab="${name}"]`).classList.add("active");
  document.getElementById("tab-"+name).style.display="block";

  if(name === "settings") updateSettingsUI();
  if(name === "enemydb") renderEnemyDB();
}

document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=> switchTab(tab.getAttribute("data-tab")));
});

/* ===================== AUTH HELPERS ===================== */
async function getCurrentProfile(){
  const { data: sessionData } = await supa.auth.getSession();
  const session = sessionData?.session;
  if(!session) return null;

  const userId = session.user.id;

  const { data: profile, error } = await supa
    .from("profiles")
    .select("*")
    .eq("id", userId)
    .maybeSingle();

  if(error || !profile) return null;
  return profile;
}

async function updateLoginUI(){
  const prof = await getCurrentProfile();
  const status = document.getElementById("loginStatus");

  if(!prof){
    status.className = "tag red";
    status.textContent = "NIEZALOGOWANY";
  }else{
    status.className = "tag green";
    status.textContent = "ZALOGOWANY: " + prof.nick;
  }
}

/* ===================== REGISTER / LOGIN ===================== */
async function registerUser(){
  const nick = document.getElementById("regNick").value.trim();
  const pass = document.getElementById("regPass").value.trim();
  const code = document.getElementById("regCode").value.trim();

  if(!nick || !pass || !code){
    toast("B≈ÇƒÖd", "Wpisz nick, has≈Ço i kod plemienia.");
    return;
  }

  // sprawd≈∫ kod plemienia w bazie
  const { data: tribeRow, error: tribeErr } = await supa
    .from("tribe_config")
    .select("tribe_code")
    .eq("id", 1)
    .maybeSingle();

  if(tribeErr || !tribeRow){
    toast("B≈ÇƒÖd", "Brak konfiguracji plemienia w bazie.");
    return;
  }

  if(code !== tribeRow.tribe_code){
    toast("B≈ÇƒÖd", "Z≈Çy kod plemienia.");
    return;
  }

  // hack: Supabase Auth wymaga emaila, wiƒôc robimy sztuczny email z nicku
  const fakeEmail = nick.toLowerCase() + "@wankosintel.com";

  const { data, error } = await supa.auth.signUp({
    email: fakeEmail,
    password: pass
  });
if(data?.user){
  const { error: profErr } = await supa
    .from("profiles")
    .insert([{
      id: data.user.id,
      nick: nick,
      is_admin: false
    }]);

  if(profErr){
    console.error(profErr);
    toast("B≈ÇƒÖd", "Konto utworzone, ale nie zapisano profilu w bazie.");
    return;
  }
}

  if(error){
    toast("B≈ÇƒÖd", "Nie uda≈Ço siƒô za≈Ço≈ºyƒá konta (mo≈ºe istnieje).");
    console.error(error);
    return;
  }

  toast("OK", "Konto utworzone. Teraz siƒô zaloguj.");
}

async function loginUser(){
  const nick = document.getElementById("loginNick").value.trim();
  const pass = document.getElementById("loginPass").value.trim();

  if(!nick || !pass){
    toast("B≈ÇƒÖd", "Podaj nick i has≈Ço.");
    return;
  }

  const fakeEmail = nick.toLowerCase() + "@wankosintel.com";

  const { error } = await supa.auth.signInWithPassword({
    email: fakeEmail,
    password: pass
  });

  if(error){
    toast("B≈ÇƒÖd", "Niepoprawny login lub has≈Ço.");
    console.error(error);
    return;
  }

  const { data: sessionData } = await supa.auth.getSession();
const session = sessionData?.session;

if(session){
  const { data: existingProfile } = await supa
    .from("profiles")
    .select("*")
    .eq("id", session.user.id)
    .maybeSingle();

  if(!existingProfile){
    await supa.from("profiles").insert([{
      id: session.user.id,
      nick: nick,
      is_admin: false
    }]);
  }
}

toast("Zalogowano", `Witaj ${nick}!`);
await updateLoginUI();
await updateSettingsUI();
unlockUI();
switchTab("labels");
}

async function logoutUser(){
  await supa.auth.signOut();
  toast("Wylogowano", "Sesja usuniƒôta.");
  await updateLoginUI();
  await updateSettingsUI();
  lockUI();
}

/* ===================== PARSER LABELS ===================== */
function parseEnemyLabels(text){
  const lines = text.split("\n").map(x=>x.trim()).filter(Boolean);
  const attacks = [];

  let currentDefender = null;

  for(const line of lines){

    const villageMatch = line.match(/\[b\]Wioska:\[\/b\]\s*\[coord\](\d{1,3}\|\d{1,3})\[\/coord\]/);
    if(villageMatch){
      currentDefender = villageMatch[1];
      continue;
    }

    if(!line.includes("[command]attack[/command]")) continue;

    const coordsMatches = [...line.matchAll(/\[coord\](\d{1,3}\|\d{1,3})\[\/coord\]/g)];
    const source = coordsMatches.length >= 1 ? coordsMatches[0][1] : null;

    const playerMatch = line.match(/\[player\](.*?)\[\/player\]/);
    const player = playerMatch ? playerMatch[1] : "UNKNOWN";

    const arrivalMatch = line.match(/Czas przybycia:\s*(\d{2}\.\d{2}\.\d{2}\s+\d{2}:\d{2}:\d{2})/);
    const arrival = arrivalMatch ? arrivalMatch[1] : null;

    if(!currentDefender) continue;

    attacks.push({
      defender: currentDefender,
      source,
      player,
      arrival,
      raw: line
    });
  }

  return attacks;
}

/* ===================== UPLOAD LABELS ===================== */
async function uploadLabels(){
  const prof = await getCurrentProfile();
  if(!prof){
    toast("Brak dostƒôpu", "Zaloguj siƒô.");
    switchTab("login");
    return;
  }

  const text = document.getElementById("labelsInput").value;
  const parsed = parseEnemyLabels(text);

  if(parsed.length === 0){
    toast("Etykiety", "Nie wykryto atak√≥w.");
    return;
  }

  const rows = parsed.map(a => ({
    owner_id: prof.id,
    owner_nick: prof.nick,
    defender: a.defender,
    source: a.source,
    player: a.player,
    arrival: a.arrival,
    raw: a.raw
  }));

  const { error } = await supa
    .from("attack_labels")
    .insert(rows);

  if(error){
    toast("B≈ÇƒÖd", "Nie uda≈Ço siƒô zapisaƒá etykiet (RLS?)");
    console.error(error);
    return;
  }

  const byDef = groupBy(parsed, a=>a.defender);
  let html = "";

  for(const def in byDef){
    html += `
      <div class="item">
        <div class="inline">
          <div>
            <div class="mono"><b>${def}</b></div>
            <div class="small">Nowych atak√≥w: <b class="mono">${byDef[def].length}</b></div>
          </div>
          <span class="tag green">OK</span>
        </div>
      </div>
    `;
  }

  document.getElementById("labelsSummary").innerHTML = html;
  toast("OK", `Dodano atak√≥w: ${parsed.length}`);
}

/* ===================== ANALYSIS ===================== */
async function runAnalysis(){
  const prof = await getCurrentProfile();
  if(!prof){
    toast("Brak dostƒôpu", "Zaloguj siƒô.");
    switchTab("login");
    return;
  }

  // all attacks in tribe db (admin sees all, user sees only allowed by RLS)
  const { data: allAttacks, error } = await supa
    .from("attack_labels")
    .select("*");

  if(error){
    toast("B≈ÇƒÖd", "Nie mo≈ºna pobraƒá bazy plemienia.");
    console.error(error);
    return;
  }

  // my attacks only
  const myAttacks = allAttacks.filter(a => a.owner_id === prof.id);

  if(myAttacks.length === 0){
    document.getElementById("threatBoard").innerHTML =
      `<div class="item small">Nie masz ≈ºadnych etykiet. Wklej dane w zak≈Çadce "Etykiety Atak√≥w".</div>`;
    return;
  }

  // repeatability from all visible attacks (admin sees all)
  const repeatMap = {};
  for(const a of allAttacks){
    if(!a.source) continue;
    repeatMap[a.source] = (repeatMap[a.source] || 0) + 1;
  }

  const byDef = groupBy(myAttacks, a=>a.defender);
  const defenders = Object.keys(byDef);

  let html = "";

  for(const def of defenders){
    const list = byDef[def];
    const uniqueSources = [...new Set(list.map(x=>x.source).filter(Boolean))];
    const maxRepeat = Math.max(1, ...uniqueSources.map(s => repeatMap[s] || 1));

    html += `
      <div class="item">
        <div class="inline">
          <div>
            <div class="mono" style="font-weight:900;">${def}</div>
            <div class="small">
              Atak√≥w: <b class="mono">${list.length}</b> ‚Ä¢ ≈πr√≥de≈Ç: <b class="mono">${uniqueSources.length}</b>
              ‚Ä¢ Max powtarzalno≈õƒá ≈∫r√≥d≈Ça: <b class="mono">${maxRepeat}</b>
            </div>
          </div>
          <span class="tag yellow">INFO</span>
        </div>

        <div class="divider"></div>

        ${list.map(a=>`
          <div class="small" style="padding:6px 0;border-bottom:1px solid var(--border);">
            <div class="mono">
              <b class="clickSource" data-src="${a.source || ""}">${a.source || "???"}</b> ‚Üí <b>${a.defender}</b>
            </div>
            <div>
              Gracz: <b class="clickPlayer" data-player="${escapeHtml(a.player || "UNKNOWN")}">${escapeHtml(a.player || "UNKNOWN")}</b>
              ‚Ä¢ Przybycie: <span class="mono">${a.arrival || "??"}</span>
              ‚Ä¢ Powtarzalno≈õƒá: <b class="mono">${repeatMap[a.source] || 1}</b>
            </div>
          </div>
        `).join("")}
      </div>
    `;
  }

  document.getElementById("threatBoard").innerHTML = html;

  document.querySelectorAll(".clickSource").forEach(el=>{
    el.addEventListener("click", ()=>{
      const coords = el.getAttribute("data-src");
      if(!coords) return;
      switchTab("enemydb");
      renderEnemyDB(coords);
    });
  });

  toast("Analiza", "Przeliczono dane.");
}

/* ===================== ENEMY TOKENS ===================== */
async function renderEnemyDB(autoCoords = null){
  const box = document.getElementById("enemyDbBox");

  const { data, error } = await supa
    .from("enemy_tokens")
    .select("coords,type,updated_at,added_by")
    .order("updated_at", { ascending:false })
    .limit(200);

  if(error){
    box.innerHTML = `<div class="item small">B≈ÇƒÖd pobierania token√≥w.</div>`;
    console.error(error);
    return;
  }

  if(!data || data.length === 0){
    box.innerHTML = `<div class="item small">Brak token√≥w w bazie.</div>`;
    return;
  }

  let html = "";
  for(const v of data){
    html += `
      <div class="item">
        <div class="inline">
          <div>
            <div class="mono"><b>${v.coords}</b></div>
            <div class="small">Typ: <b>${v.type || "UNKNOWN"}</b> ‚Ä¢ Dodane przez: <b>${escapeHtml(v.added_by || "?")}</b></div>
          </div>
          <span class="tag blue">${v.type || "?"}</span>
        </div>
      </div>
    `;
  }

  box.innerHTML = html;

  if(autoCoords){
    toast("Baza Wroga", `Przej≈õcie do: ${autoCoords}`);
  }

  await updateAdminTokenPanel();
}

async function updateAdminTokenPanel(){
  const prof = await getCurrentProfile();
  const panel = document.getElementById("adminTokenPanel");

  if(prof && prof.is_admin){
    panel.style.display = "block";
  }else{
    panel.style.display = "none";
  }
}

/* ===================== TOKENS UPLOAD (ADMIN) ===================== */
function extractTokens(text){
  const re = /HN[12]:[A-Za-z0-9+\/=\-$]+/g;
  return text.match(re) || [];
}

async function uploadTokens(){
  const prof = await getCurrentProfile();
  if(!prof || !prof.is_admin){
    toast("Brak dostƒôpu", "Tylko admin mo≈ºe dodawaƒá tokeny.");
    return;
  }

  const text = document.getElementById("tokenInput").value;
  const tokens = extractTokens(text);

  if(tokens.length === 0){
    toast("Tokeny", "Nie wykryto HN1/HN2.");
    return;
  }

  // placeholder: zapisujemy tylko token tekstowy, coords trzeba dodaƒá parser jak w starej wersji
  // tutaj wstawiamy "UNKNOWN|UNKNOWN" bo parser token√≥w jest d≈Çugi
  // Jak chcesz, w kolejnym kroku pod≈ÇƒÖczymy Tw√≥j stary decodeHN i troops parser.

  const rows = tokens.map(t => ({
    coords: "???|???",
    token: t,
    type: "UNKNOWN",
    troops: {},
    added_by: prof.nick
  }));

  const { error } = await supa.from("enemy_tokens").insert(rows);

  if(error){
    toast("B≈ÇƒÖd", "Nie uda≈Ço siƒô dodaƒá token√≥w.");
    console.error(error);
    return;
  }

  toast("OK", `Dodano token√≥w: ${tokens.length}`);
  document.getElementById("tokenInput").value = "";
  renderEnemyDB();
}

/* ===================== SETTINGS ===================== */
async function deleteMyLabels(){
  const prof = await getCurrentProfile();
  if(!prof){
    toast("Brak dostƒôpu", "Zaloguj siƒô.");
    return;
  }

  if(!confirm("UsunƒÖƒá wszystkie Twoje etykiety z bazy?")) return;

  const { error } = await supa
    .from("attack_labels")
    .delete()
    .eq("owner_id", prof.id);

  if(error){
    toast("B≈ÇƒÖd", "Nie uda≈Ço siƒô usunƒÖƒá etykiet.");
    console.error(error);
    return;
  }

  toast("OK", "Usuniƒôto Twoje etykiety.");
}

async function makeUserAdmin(userId, val){
  const prof = await getCurrentProfile();
  if(!prof || !prof.is_admin){
    toast("Brak dostƒôpu", "Tylko admin mo≈ºe to robiƒá.");
    return;
  }

  const { error } = await supa
    .from("profiles")
    .update({ is_admin: val })
    .eq("id", userId);

  if(error){
    toast("B≈ÇƒÖd", "Nie uda≈Ço siƒô zmieniƒá uprawnie≈Ñ.");
    console.error(error);
    return;
  }

  toast("OK", val ? "Nadano admina." : "Zabrano admina.");
  updateSettingsUI();
}

async function updateSettingsUI(){
  const prof = await getCurrentProfile();
  const tag = document.getElementById("adminTag");
  const adminPanel = document.getElementById("adminPanel");

  if(!prof){
    tag.className = "tag red";
    tag.textContent = "USER";
    adminPanel.innerHTML = `<div class="item small">Zaloguj siƒô aby zobaczyƒá ustawienia.</div>`;
    return;
  }

  if(prof.is_admin){
    tag.className = "tag green";
    tag.textContent = "ADMIN";

    const { data: users, error } = await supa
      .from("profiles")
      .select("id,nick,is_admin,created_at")
      .order("created_at", { ascending:true });

    if(error){
      adminPanel.innerHTML = `<div class="item small">B≈ÇƒÖd pobierania listy u≈ºytkownik√≥w.</div>`;
      console.error(error);
      return;
    }

    let html = `<div class="item small"><b>Lista u≈ºytkownik√≥w:</b></div>`;

    for(const u of users){
      html += `
        <div class="item">
          <div class="inline">
            <div>
              <div class="mono"><b>${escapeHtml(u.nick || "?")}</b></div>
              <div class="small">
                Admin: <b>${u.is_admin ? "TAK" : "NIE"}</b>
              </div>
            </div>
            <div>
              ${u.id !== prof.id ? `
                <button class="btnGhost" data-makeadmin="${u.id}" data-val="${u.is_admin ? "0" : "1"}">
                  ${u.is_admin ? "Zabierz admina" : "Nadaj admina"}
                </button>
              ` : `<span class="tag green">TY</span>`}
            </div>
          </div>
        </div>
      `;
    }

    adminPanel.innerHTML = html;

    adminPanel.querySelectorAll("[data-makeadmin]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-makeadmin");
        const val = btn.getAttribute("data-val") === "1";
        makeUserAdmin(id, val);
      });
    });

  }else{
    tag.className = "tag blue";
    tag.textContent = "USER";
    adminPanel.innerHTML = `<div class="item small">Tylko admin ma dostƒôp.</div>`;
  }

  await updateAdminTokenPanel();
}

/* ===================== EVENTS ===================== */
document.getElementById("btnRegister").addEventListener("click", registerUser);
document.getElementById("btnLogin").addEventListener("click", loginUser);
document.getElementById("btnLogout").addEventListener("click", logoutUser);

document.getElementById("btnUploadLabels").addEventListener("click", uploadLabels);
document.getElementById("btnClearLabels").addEventListener("click", ()=>{
  document.getElementById("labelsInput").value = "";
  document.getElementById("labelsSummary").innerHTML = `<div class="item small">Brak danych.</div>`;
});

document.getElementById("btnRunAnalysis").addEventListener("click", runAnalysis);
document.getElementById("btnDeleteMyLabels").addEventListener("click", deleteMyLabels);

document.getElementById("btnUploadTokens").addEventListener("click", uploadTokens);

/* ===================== INIT ===================== */
(async ()=>{
  const { data: sessionData } = await supa.auth.getSession();
  const session = sessionData?.session;

  if(!session){
    await updateLoginUI();
    lockUI();
    return;
  }

  await updateLoginUI();
  await updateSettingsUI();
  unlockUI();
  switchTab("labels");
})();
</script>

</body>
</html>
