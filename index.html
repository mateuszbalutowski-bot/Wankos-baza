<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tribal Intel Panel (Supabase)</title>

  <style>
    :root{
      --bg:#0b0f17;
      --panel:#111827;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#60a5fa;
      --accent2:#34d399;
      --warn:#fbbf24;
      --danger:#fb7185;
      --ok:#22c55e;
      --border:rgba(255,255,255,0.07);
      --shadow: 0 12px 50px rgba(0,0,0,0.4);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", Arial;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 900px at 15% 10%, rgba(96,165,250,0.16), transparent 60%),
                  radial-gradient(1200px 900px at 90% 40%, rgba(52,211,153,0.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    header{
      padding:18px 18px;
      border-bottom:1px solid var(--border);
      background:rgba(17,24,39,0.6);
      backdrop-filter: blur(8px);
      position:sticky;
      top:0;
      z-index:10;
    }

    .wrap{ max-width:1200px; margin:0 auto; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:18px;
      flex-wrap:wrap;
    }

    h1{
      margin:0;
      font-size:16px;
      letter-spacing:0.2px;
      font-weight:800;
    }

    .subtitle{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      line-height:1.3;
    }

    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .tab{
      cursor:pointer;
      padding:9px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(2,6,23,0.35);
      color: var(--muted);
      font-weight:800;
      font-size:12px;
      user-select:none;
      transition:.15s;
    }

    .tab:hover{ filter:brightness(1.08); transform: translateY(-1px); }

    .tab.active{
      color: #0b1220;
      border-color: rgba(96,165,250,0.35);
      background: linear-gradient(180deg, rgba(96,165,250,1), rgba(59,130,246,1));
    }

    main{ padding:20px 18px 80px; }

    .card{
      background: linear-gradient(180deg, rgba(17,24,39,0.95), rgba(15,23,42,0.95));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      overflow:hidden;
      margin-bottom:16px;
    }

    .card h2{
      margin:0;
      font-size:13px;
      font-weight:900;
      letter-spacing:0.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .hint{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }

    textarea, input{
      width:100%;
      background: rgba(2,6,23,0.55);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      color:var(--text);
      font-size:13px;
      outline:none;
      transition:0.15s;
      font-family:var(--sans);
    }

    textarea{
      min-height:160px;
      resize:vertical;
      font-family:var(--mono);
      line-height:1.35;
      font-size:12px;
      margin-top:12px;
    }

    textarea:focus, input:focus{
      border-color: rgba(96,165,250,0.5);
      box-shadow:0 0 0 4px rgba(96,165,250,0.12);
    }

    button{
      border:none;
      cursor:pointer;
      border-radius:12px;
      padding:10px 14px;
      font-weight:900;
      font-size:12px;
      transition:0.15s;
      display:inline-flex;
      align-items:center;
      gap:8px;
      color:#0b1220;
      background: linear-gradient(180deg, rgba(96,165,250,1), rgba(59,130,246,1));
    }

    button:hover{ transform: translateY(-1px); filter:brightness(1.05); }
    button:active{ transform: translateY(0px); filter:brightness(0.98); }

    .btn2{
      background: linear-gradient(180deg, rgba(52,211,153,1), rgba(16,185,129,1));
    }

    .btnDanger{
      background: linear-gradient(180deg, rgba(251,113,133,1), rgba(244,63,94,1));
    }

    .btnGhost{
      background: rgba(15,23,42,0.8);
      border:1px solid var(--border);
      color:var(--text);
    }

    .row{
      display:flex;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
      align-items:center;
    }

    .mono{ font-family:var(--mono); }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:11px;
      color:var(--muted);
      background: rgba(2,6,23,0.4);
      user-select:none;
      font-weight:900;
    }

    .tag.green{ color:rgba(34,197,94,0.95); border-color: rgba(34,197,94,0.25); }
    .tag.red{ color:rgba(251,113,133,0.95); border-color: rgba(251,113,133,0.25); }
    .tag.yellow{ color:rgba(251,191,36,0.95); border-color: rgba(251,191,36,0.25); }
    .tag.blue{ color:rgba(96,165,250,0.95); border-color: rgba(96,165,250,0.25); }

    .divider{
      height:1px;
      background: var(--border);
      margin: 14px 0;
    }

    .listBox{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(2,6,23,0.35);
      overflow:hidden;
    }

    .item{
      padding:12px 12px;
      border-bottom:1px solid var(--border);
      transition:.12s;
    }
    .item:last-child{ border-bottom:none; }

    .inline{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      flex-wrap:wrap;
    }

    .small{
      font-size:11px;
      color:var(--muted);
      line-height:1.4;
    }

    .toast{
      position: fixed;
      bottom: 20px;
      right: 20px;
      max-width: 360px;
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(17,24,39,0.95);
      box-shadow: var(--shadow);
      color: var(--text);
      font-size: 12px;
      display:none;
      z-index:999;
    }
    .toast strong{
      display:block;
      margin-bottom:6px;
      font-size:12px;
    }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
<header>
  <div class="wrap topbar">
    <div>
      <h1>Tribal Intel Panel</h1>
      <div class="subtitle">
        Panel plemienny (Supabase Auth + DB).
        <br>
        <span id="userInfo" class="small"></span>
      </div>
    </div>

    <div class="tabs" id="tabsBar">
      <div class="tab active" data-tab="login">Logowanie</div>
      <div class="tab" data-tab="labels">Etykiety Atak√≥w</div>
      <div class="tab" data-tab="analysis">Analiza Etykiet</div>
      <div class="tab" data-tab="enemydb">Baza Token√≥w</div>
      <div class="tab" data-tab="notes">Notatki Token√≥w</div>
      <div class="tab" data-tab="settings">Ustawienia</div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">

    <!-- TAB: LOGIN -->
    <div class="tabPanel" id="tab-login">
      <div class="card">
        <h2>üîê Logowanie / Rejestracja <span id="loginStatus" class="tag red">NIEZALOGOWANY</span></h2>

        <div class="hint">
          Rejestracja wymaga kodu plemienia. Konto jest tworzone w Supabase Auth.
        </div>

        <div class="divider"></div>

        <h2>üìå Logowanie</h2>
        <div class="row">
          <input id="loginNick" placeholder="Nick w grze..." class="mono"/>
          <input id="loginPass" type="password" placeholder="Has≈Ço..."/>
          <button id="btnLogin" class="btn2">Zaloguj</button>
        </div>

        <div class="divider"></div>

        <h2>‚ûï Rejestracja</h2>
        <div class="row">
          <input id="regNick" placeholder="Nick w grze..." class="mono"/>
          <input id="regPass" type="password" placeholder="Has≈Ço..."/>
          <input id="regCode" placeholder="Kod plemienia..." class="mono"/>
          <button id="btnRegister">Zarejestruj konto</button>
        </div>
      </div>
    </div>

    <!-- TAB: LABELS -->
    <div class="tabPanel" id="tab-labels" style="display:none;">
      <div class="card">
        <h2>üè∑Ô∏è Etykiety Atak√≥w <span class="tag blue">Supabase DB</span></h2>

        <div class="hint">
          Wklej etykiety. ZostanƒÖ zapisane w bazie plemienia w Supabase.
        </div>

        <textarea id="labelsInput" placeholder="Wklej etykiety atak√≥w tutaj..."></textarea>

        <div class="row">
          <button id="btnParseLabels" class="btn2">üì• Wy≈õlij etykiety</button>
          <button id="btnClearLabels" class="btnGhost">üßπ Wyczy≈õƒá</button>
        </div>

        <div class="divider"></div>

        <h2>üìå Podsumowanie</h2>
        <div id="labelsSummary" class="listBox">
          <div class="item small">Brak danych.</div>
        </div>
      </div>
    </div>

    <!-- TAB: ANALYSIS -->
    <div class="tabPanel" id="tab-analysis" style="display:none;">
      <div class="card">
        <h2>üìä Analiza Etykiet <span class="tag yellow">Threat Engine</span></h2>

        <div class="hint">
          Analiza dzia≈Ça na danych pobranych z Supabase.
        </div>

        <div class="row">
          <button id="btnRunThreat" class="btn2">‚ö° Przelicz zagro≈ºenia</button>
          <button id="btnClearThreat" class="btnGhost">üßπ Wyczy≈õƒá</button>
        </div>

        <div id="threatBoard" class="listBox">
          <div class="item small">Brak analizy.</div>
        </div>
      </div>
    </div>

    <!-- TAB: ENEMY DB -->
    <div class="tabPanel" id="tab-enemydb" style="display:none;">
      <div class="card">
        <h2>üè∞ Baza Token√≥w <span class="tag green">enemy_tokens</span></h2>

        <div class="hint">
          Lista token√≥w zapisanych w bazie Supabase. Bez dekodowania (RAW).
        </div>

        <div id="enemyList" class="listBox">
          <div class="item small">Brak danych.</div>
        </div>
      </div>
    </div>

    <!-- TAB: NOTES -->
    <div class="tabPanel" id="tab-notes" style="display:none;">
      <div class="card">
        <h2>üóíÔ∏è Tokeny (RAW) <span id="adminTag" class="tag red">BRAK UPRAWNIE≈É</span></h2>

        <div class="hint">
          Dodawanie token√≥w jest dostƒôpne tylko dla admina.
        </div>

        <textarea id="notesInput" placeholder="Wklej tokeny HN1/HN2..."></textarea>

        <div class="row">
          <button id="btnParseTokens">üîç Wczytaj tokeny</button>
          <button id="btnAddTokens" class="btn2">‚ûï Dodaj tokeny do Supabase</button>
          <button id="btnClearNotes" class="btnGhost">üßπ Wyczy≈õƒá</button>
        </div>

        <div class="divider"></div>

        <h2>üìå Statystyki</h2>
        <div id="tokenStats" class="listBox">
          <div class="item small">Brak danych.</div>
        </div>
      </div>
    </div>

    <!-- TAB: SETTINGS -->
    <div class="tabPanel" id="tab-settings" style="display:none;">
      <div class="card">
        <h2>‚öôÔ∏è Ustawienia <span class="tag blue">Panel</span></h2>

        <div class="hint">
          Mo≈ºesz usuwaƒá swoje etykiety. Admin ma dodatkowe uprawnienia.
        </div>

        <div class="divider"></div>

        <h2>üë§ Konto</h2>
        <div class="row">
          <button id="btnLogout" class="btnDanger">Wyloguj</button>
          <button id="btnDeleteMyLabels" class="btnDanger">Usu≈Ñ moje etykiety</button>
        </div>

        <div id="adminPanel" class="hidden">
          <div class="divider"></div>

          <h2>üëë Panel Admina</h2>
          <div class="hint">
            Mo≈ºesz nadaƒá admina innemu u≈ºytkownikowi.
          </div>

          <div class="divider"></div>

          <div class="row">
            <input id="adminNickInput" placeholder="Nick gracza..." class="mono"/>
            <button id="btnGrantAdmin" class="btn2">Nadaj admina</button>
            <button id="btnRevokeAdmin" class="btnDanger">Usu≈Ñ admina</button>
          </div>

          <div class="divider"></div>

          <h2>üìå Lista u≈ºytkownik√≥w</h2>
          <div id="adminStats" class="listBox">
            <div class="item small">Brak danych.</div>
          </div>
        </div>

      </div>
    </div>

  </div>
</main>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ===================== SUPABASE CONFIG ===================== */
const SUPABASE_URL = "https://cixrktawkfxaexhzhnho.supabase.co";
const SUPABASE_KEY = "sb_publishable_kUYmC66z6c9g3qrj0hx2Zg_ZV__s0zA";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===================== CONFIG ===================== */
const TRIBE_CODE = "Wankos2026";

/* ===================== UTIL ===================== */
function nowISO(){ return new Date().toISOString(); }

function toast(title, msg){
  const t = document.getElementById("toast");
  t.innerHTML = `<strong>${escapeHtml(title)}</strong>${escapeHtml(msg)}`;
  t.style.display = "block";
  setTimeout(()=>{ t.style.display="none"; }, 2800);
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

function groupBy(arr, keyFn){
  const m = {};
  for(const item of arr){
    const k = keyFn(item);
    if(!m[k]) m[k] = [];
    m[k].push(item);
  }
  return m;
}

/* ===================== TOKEN PARSER (RAW) ===================== */
function extractTokens(text){
  const re = /HN[12]:[A-Za-z0-9+\/=\-$]+/g;
  return text.match(re) || [];
}

/* ===================== AUTH ===================== */
async function getCurrentProfile(){
  const { data: sessionData } = await supa.auth.getSession();
  const session = sessionData?.session;
  if(!session) return null;

  const userId = session.user.id;

  const { data: profile } = await supa
    .from("profiles")
    .select("*")
    .eq("id", userId)
    .maybeSingle();

  return profile || null;
}

async function updateUserUI(){
  const prof = await getCurrentProfile();
  const info = document.getElementById("userInfo");
  const status = document.getElementById("loginStatus");

  if(!prof){
    info.innerHTML = `<span class="tag red">NIEZALOGOWANY</span>`;
    status.className = "tag red";
    status.textContent = "NIEZALOGOWANY";
    document.getElementById("adminPanel").classList.add("hidden");
    document.getElementById("adminTag").className = "tag red";
    document.getElementById("adminTag").textContent = "BRAK UPRAWNIE≈É";
    lockTabs();
    return;
  }

  const role = prof.is_admin ? `<span class="tag green">ADMIN</span>` : `<span class="tag blue">USER</span>`;
  info.innerHTML = `Zalogowany: <b class="mono">${escapeHtml(prof.nick)}</b> ${role}`;

  status.className = "tag green";
  status.textContent = "ZALOGOWANY";

  document.getElementById("adminTag").className = prof.is_admin ? "tag green" : "tag red";
  document.getElementById("adminTag").textContent = prof.is_admin ? "ADMIN" : "BRAK UPRAWNIE≈É";

  document.getElementById("adminPanel").classList.toggle("hidden", !prof.is_admin);

  unlockTabs();
}

/* ===================== UI LOCK ===================== */
function lockTabs(){
  document.querySelectorAll(".tab").forEach(t=>{
    const name = t.getAttribute("data-tab");
    if(name === "login"){
      t.style.display = "inline-flex";
    }else{
      t.style.display = "none";
    }
  });
  switchTab("login");
}

function unlockTabs(){
  document.querySelectorAll(".tab").forEach(t=>{
    t.style.display = "inline-flex";
  });
}

/* ===================== TAB SYSTEM ===================== */
async function switchTab(name){
  const prof = await getCurrentProfile();

  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tabPanel").forEach(p=>p.style.display="none");

  const tab = document.querySelector(`.tab[data-tab="${name}"]`);
  if(tab) tab.classList.add("active");

  const panel = document.getElementById("tab-"+name);
  if(panel) panel.style.display = "block";

  if(!prof && name !== "login"){
    switchTab("login");
    return;
  }

  if(name === "analysis") renderThreatBoard();
  if(name === "enemydb") renderEnemyDB();
  if(name === "notes") renderTokenStats();
  if(name === "settings"){
    if(prof && prof.is_admin){
      renderAdminUsers();
    }
  }
}

document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=> switchTab(tab.getAttribute("data-tab")));
});

/* ===================== REGISTER / LOGIN ===================== */
async function registerUser(){
  const nick = document.getElementById("regNick").value.trim();
  const pass = document.getElementById("regPass").value.trim();
  const code = document.getElementById("regCode").value.trim();

  if(!nick || !pass || !code){
    toast("B≈ÇƒÖd", "Wpisz nick, has≈Ço i kod plemienia.");
    return;
  }

  if(code !== TRIBE_CODE){
    toast("B≈ÇƒÖd", "Niepoprawny kod plemienia.");
    return;
  }

  const fakeEmail = nick.toLowerCase() + "@tribalintel.com";

  const { data, error } = await supa.auth.signUp({
    email: fakeEmail,
    password: pass
  });

  if(error){
    console.error(error);
    toast("B≈ÇƒÖd", error.message);
    return;
  }

  if(data?.user){
    const { error: profErr } = await supa
      .from("profiles")
      .insert([{
        id: data.user.id,
        nick: nick,
        is_admin: false
      }]);

    if(profErr){
      console.error(profErr);
      toast("B≈ÇƒÖd", "Konto utworzone, ale nie zapisano profilu.");
      return;
    }
  }

  toast("OK", "Konto utworzone. Teraz siƒô zaloguj.");
}

async function loginUser(){
  const nick = document.getElementById("loginNick").value.trim();
  const pass = document.getElementById("loginPass").value.trim();

  if(!nick || !pass){
    toast("B≈ÇƒÖd", "Podaj nick i has≈Ço.");
    return;
  }

  const fakeEmail = nick.toLowerCase() + "@tribalintel.com";

  const { error } = await supa.auth.signInWithPassword({
    email: fakeEmail,
    password: pass
  });

  if(error){
    console.error(error);
    toast("B≈ÇƒÖd", "Niepoprawny login lub has≈Ço.");
    return;
  }

  toast("OK", `Zalogowano jako ${nick}`);
  await updateUserUI();
  switchTab("labels");
}

async function logoutUser(){
  await supa.auth.signOut();
  toast("OK", "Wylogowano.");
  await updateUserUI();
  switchTab("login");
}

/* ===================== LABEL PARSER ===================== */
function parseEnemyLabels(text){
  const lines = text.split("\n").map(x=>x.trim()).filter(Boolean);
  const attacks = [];
  let currentDefender = null;

  for(const line of lines){
    const villageMatch = line.match(/\[b\]Wioska:\[\/b\]\s*\[coord\](\d{1,3}\|\d{1,3})\[\/coord\]/);
    if(villageMatch){
      currentDefender = villageMatch[1];
      continue;
    }

    if(!line.includes("[command]attack[/command]")) continue;

    const coordsMatches = [...line.matchAll(/\[coord\](\d{1,3}\|\d{1,3})\[\/coord\]/g)];
    const source = coordsMatches.length >= 1 ? coordsMatches[0][1] : null;

    const playerMatch = line.match(/\[player\](.*?)\[\/player\]/);
    const player = playerMatch ? playerMatch[1] : "UNKNOWN";

    const arrivalMatch = line.match(/Czas przybycia:\s*(\d{2}\.\d{2}\.\d{2}\s+\d{2}:\d{2}:\d{2})/);
    const arrival = arrivalMatch ? arrivalMatch[1] : null;

    if(!currentDefender) continue;

    attacks.push({
      defender: currentDefender,
      source,
      player,
      arrival,
      raw: line
    });
  }

  return attacks;
}

/* ===================== UPLOAD LABELS ===================== */
async function uploadLabels(){
  const prof = await getCurrentProfile();
  if(!prof){
    toast("B≈ÇƒÖd", "Zaloguj siƒô.");
    switchTab("login");
    return;
  }

  const text = document.getElementById("labelsInput").value;
  const parsed = parseEnemyLabels(text);

  if(parsed.length === 0){
    toast("Etykiety", "Nie wykryto atak√≥w.");
    return;
  }

  const rows = parsed.map(a => ({
    owner_id: prof.id,
    defender: a.defender,
    source: a.source,
    player: a.player,
    arrival: a.arrival,
    raw: a.raw
  }));

  const { error } = await supa.from("attack_labels").insert(rows);

  if(error){
    console.error(error);
    toast("B≈ÇƒÖd", error.message);
    return;
  }

  const byDef = groupBy(parsed, a=>a.defender);

  let html = "";
  for(const def in byDef){
    html += `
      <div class="item">
        <div class="inline">
          <div>
            <div class="mono"><b>${escapeHtml(def)}</b></div>
            <div class="small">Nowych atak√≥w: <b class="mono">${byDef[def].length}</b></div>
          </div>
          <span class="tag blue">OK</span>
        </div>
      </div>
    `;
  }

  document.getElementById("labelsSummary").innerHTML = html;
  toast("OK", `Dodano atak√≥w: ${parsed.length}`);
}

/* ===================== ANALYSIS ===================== */
async function renderThreatBoard(){
  const prof = await getCurrentProfile();
  if(!prof) return;

  const { data: allAttacks, error } = await supa
    .from("attack_labels")
    .select("*");

  if(error){
    console.error(error);
    document.getElementById("threatBoard").innerHTML =
      `<div class="item small">B≈ÇƒÖd pobierania etykiet.</div>`;
    return;
  }

  if(!allAttacks || allAttacks.length === 0){
    document.getElementById("threatBoard").innerHTML =
      `<div class="item small">Brak danych w bazie.</div>`;
    return;
  }

  // pokazujemy tylko moje defendery (z moich etykiet)
  const myDefenders = [...new Set(allAttacks.filter(a=>a.owner_id === prof.id).map(a=>a.defender))];
  const myAttacks = allAttacks.filter(a=> myDefenders.includes(a.defender));

  if(myAttacks.length === 0){
    document.getElementById("threatBoard").innerHTML =
      `<div class="item small">Nie masz atak√≥w przypisanych do swoich defender√≥w.</div>`;
    return;
  }

  const byDef = groupBy(myAttacks, a=>a.defender);

  // repeatability global
  const repeatMap = {};
  for(const a of allAttacks){
    if(!a.source) continue;
    repeatMap[a.source] = (repeatMap[a.source] || 0) + 1;
  }

  let html = "";

  for(const def in byDef){
    const list = byDef[def];
    const uniqueSources = [...new Set(list.map(x=>x.source).filter(Boolean))];
    const maxRepeat = Math.max(1, ...uniqueSources.map(s => repeatMap[s] || 1));

    html += `
      <div class="item">
        <div class="inline">
          <div>
            <div class="mono" style="font-weight:900;">${escapeHtml(def)}</div>
            <div class="small">
              Atak√≥w: <b class="mono">${list.length}</b> ‚Ä¢ ≈πr√≥de≈Ç: <b class="mono">${uniqueSources.length}</b>
              ‚Ä¢ Max powtarzalno≈õƒá ≈∫r√≥d≈Ça: <b class="mono">${maxRepeat}</b>
            </div>
          </div>
          <span class="tag yellow">INFO</span>
        </div>
      </div>
    `;
  }

  document.getElementById("threatBoard").innerHTML = html;
}

/* ===================== TOKEN RAW DB ===================== */
async function renderEnemyDB(){
  const prof = await getCurrentProfile();
  if(!prof) return;

  const box = document.getElementById("enemyList");

  const { data, error } = await supa
    .from("enemy_tokens")
    .select("id,token,added_by,updated_at,type,coords")
    .order("updated_at", { ascending:false })
    .limit(100);

  if(error){
    console.error(error);
    box.innerHTML = `<div class="item small">B≈ÇƒÖd pobierania token√≥w.</div>`;
    return;
  }

  if(!data || data.length === 0){
    box.innerHTML = `<div class="item small">Brak token√≥w w bazie.</div>`;
    return;
  }

  let html = "";
  for(const row of data){
    html += `
      <div class="item">
        <div class="inline">
          <div>
            <div class="small">ID: <span class="mono">${row.id}</span></div>
            <div class="small">Dodane przez: <b>${escapeHtml(row.added_by || "?")}</b></div>
            <div class="small">Czas: <span class="mono">${new Date(row.updated_at).toLocaleString()}</span></div>
          </div>
          <span class="tag blue">${escapeHtml(row.type || "RAW")}</span>
        </div>
      </div>
    `;
  }

  box.innerHTML = html;
}

async function renderTokenStats(){
  const prof = await getCurrentProfile();
  if(!prof) return;

  const { data, error } = await supa
    .from("enemy_tokens")
    .select("id", { count:"exact", head:true });

  if(error){
    console.error(error);
    document.getElementById("tokenStats").innerHTML =
      `<div class="item small">B≈ÇƒÖd pobierania statystyk.</div>`;
    return;
  }

  document.getElementById("tokenStats").innerHTML =
    `<div class="item small">Token√≥w w bazie: <b class="mono">${data?.length || 0}</b></div>`;
}

async function uploadTokensRAW(){
  const prof = await getCurrentProfile();
  if(!prof || !prof.is_admin){
    toast("Brak dostƒôpu", "Tylko admin mo≈ºe dodawaƒá tokeny.");
    return;
  }

  const text = document.getElementById("notesInput").value;
  const tokens = extractTokens(text);

  if(tokens.length === 0){
    toast("Tokeny", "Nie wykryto HN1/HN2.");
    return;
  }

  const rows = tokens.map(t => ({
    token: t,
    coords: null,
    type: "RAW",
    troops: null,
    added_by: prof.nick
  }));

  const { error } = await supa.from("enemy_tokens").insert(rows);

  if(error){
    console.error(error);
    toast("B≈ÇƒÖd", error.message);
    return;
  }

  toast("OK", `Dodano token√≥w: ${rows.length}`);
  document.getElementById("notesInput").value = "";
  renderEnemyDB();
  renderTokenStats();
}

/* ===================== DELETE MY LABELS ===================== */
async function deleteMyLabels(){
  const prof = await getCurrentProfile();
  if(!prof){
    toast("B≈ÇƒÖd", "Zaloguj siƒô.");
    return;
  }

  if(!confirm("UsunƒÖƒá wszystkie Twoje etykiety z bazy?")) return;

  const { error } = await supa
    .from("attack_labels")
    .delete()
    .eq("owner_id", prof.id);

  if(error){
    console.error(error);
    toast("B≈ÇƒÖd", error.message);
    return;
  }

  toast("OK", "Usuniƒôto Twoje etykiety.");
}

/* ===================== ADMIN USERS ===================== */
async function renderAdminUsers(){
  const prof = await getCurrentProfile();
  if(!prof || !prof.is_admin) return;

  const { data: users, error } = await supa
    .from("profiles")
    .select("id,nick,is_admin,created_at")
    .order("created_at", { ascending:true });

  if(error){
    console.error(error);
    document.getElementById("adminStats").innerHTML =
      `<div class="item small">B≈ÇƒÖd pobierania u≈ºytkownik√≥w.</div>`;
    return;
  }

  let html = "";

  for(const u of users){
    html += `
      <div class="item">
        <div class="inline">
          <div>
            <div class="mono"><b>${escapeHtml(u.nick)}</b></div>
            <div class="small">Admin: <b>${u.is_admin ? "TAK" : "NIE"}</b></div>
          </div>
          <span class="tag ${u.is_admin ? "green" : "blue"}">${u.is_admin ? "ADMIN" : "USER"}</span>
        </div>
      </div>
    `;
  }

  document.getElementById("adminStats").innerHTML = html;
}

async function setAdminByNick(nick, val){
  const prof = await getCurrentProfile();
  if(!prof || !prof.is_admin){
    toast("Brak dostƒôpu", "Tylko admin.");
    return;
  }

  nick = nick.trim();
  if(!nick){
    toast("B≈ÇƒÖd", "Podaj nick.");
    return;
  }

  const { data: target, error: findErr } = await supa
    .from("profiles")
    .select("id,nick,is_admin")
    .eq("nick", nick)
    .maybeSingle();

  if(findErr || !target){
    toast("B≈ÇƒÖd", "Nie znaleziono u≈ºytkownika.");
    return;
  }

  const { error } = await supa
    .from("profiles")
    .update({ is_admin: val })
    .eq("id", target.id);

  if(error){
    console.error(error);
    toast("B≈ÇƒÖd", error.message);
    return;
  }

  toast("OK", val ? "Nadano admina." : "Zabrano admina.");
  renderAdminUsers();
}

/* ===================== EVENTS ===================== */
document.getElementById("btnRegister").addEventListener("click", registerUser);
document.getElementById("btnLogin").addEventListener("click", loginUser);
document.getElementById("btnLogout").addEventListener("click", logoutUser);

document.getElementById("btnParseLabels").addEventListener("click", uploadLabels);
document.getElementById("btnClearLabels").addEventListener("click", ()=>{
  document.getElementById("labelsInput").value = "";
  document.getElementById("labelsSummary").innerHTML = `<div class="item small">Brak danych.</div>`;
});

document.getElementById("btnRunThreat").addEventListener("click", renderThreatBoard);
document.getElementById("btnClearThreat").addEventListener("click", ()=>{
  document.getElementById("threatBoard").innerHTML = `<div class="item small">Wyczy≈õci≈Çe≈õ analizƒô (nie usuwa danych w bazie).</div>`;
});

document.getElementById("btnDeleteMyLabels").addEventListener("click", deleteMyLabels);

document.getElementById("btnParseTokens").addEventListener("click", ()=>{
  const text = document.getElementById("notesInput").value;
  const tokens = extractTokens(text);
  document.getElementById("tokenStats").innerHTML =
    `<div class="item small">Wykryto token√≥w: <b class="mono">${tokens.length}</b></div>`;
  toast("Tokeny", `Wykryto: ${tokens.length}`);
});

document.getElementById("btnAddTokens").addEventListener("click", uploadTokensRAW);

document.getElementById("btnClearNotes").addEventListener("click", ()=>{
  document.getElementById("notesInput").value = "";
  toast("Notatki", "Wyczyszczono.");
});

document.getElementById("btnGrantAdmin").addEventListener("click", ()=>{
  const nick = document.getElementById("adminNickInput").value;
  setAdminByNick(nick, true);
});
document.getElementById("btnRevokeAdmin").addEventListener("click", ()=>{
  const nick = document.getElementById("adminNickInput").value;
  setAdminByNick(nick, false);
});

/* ===================== INIT ===================== */
(async ()=>{
  await updateUserUI();
})();
</script>

</body>
</html>
