<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Wankos Intel Panel (Supabase)</title>

  <style>
    :root{
      --bg:#0b0f17;
      --panel:#111827;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#60a5fa;
      --accent2:#34d399;
      --warn:#fbbf24;
      --danger:#fb7185;
      --ok:#22c55e;
      --border:rgba(255,255,255,0.07);
      --shadow: 0 12px 50px rgba(0,0,0,0.4);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", Arial;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 900px at 15% 10%, rgba(96,165,250,0.16), transparent 60%),
                  radial-gradient(1200px 900px at 90% 40%, rgba(52,211,153,0.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    header{
      padding:18px 18px;
      border-bottom:1px solid var(--border);
      background:rgba(17,24,39,0.6);
      backdrop-filter: blur(8px);
      position:sticky;
      top:0;
      z-index:10;
    }

    .wrap{ max-width:1200px; margin:0 auto; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:18px;
      flex-wrap:wrap;
    }

    h1{
      margin:0;
      font-size:16px;
      letter-spacing:0.2px;
      font-weight:900;
    }

    .subtitle{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      line-height:1.3;
    }

    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .tab{
      cursor:pointer;
      padding:9px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(2,6,23,0.35);
      color: var(--muted);
      font-weight:900;
      font-size:12px;
      user-select:none;
      transition:.15s;
    }

    .tab:hover{ filter:brightness(1.08); transform: translateY(-1px); }

    .tab.active{
      color: #0b1220;
      border-color: rgba(96,165,250,0.35);
      background: linear-gradient(180deg, rgba(96,165,250,1), rgba(59,130,246,1));
    }

    main{ padding:20px 18px 80px; }

    .card{
      background: linear-gradient(180deg, rgba(17,24,39,0.95), rgba(15,23,42,0.95));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      overflow:hidden;
      margin-bottom:16px;
    }

    .card h2{
      margin:0;
      font-size:13px;
      font-weight:900;
      letter-spacing:0.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .hint{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }

    textarea, input{
      width:100%;
      background: rgba(2,6,23,0.55);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      color:var(--text);
      font-size:13px;
      outline:none;
      transition:0.15s;
      font-family:var(--sans);
    }

    textarea{
      min-height:160px;
      resize:vertical;
      font-family:var(--mono);
      line-height:1.35;
      font-size:12px;
      margin-top:12px;
    }

    textarea:focus, input:focus{
      border-color: rgba(96,165,250,0.5);
      box-shadow:0 0 0 4px rgba(96,165,250,0.12);
    }

    button{
      border:none;
      cursor:pointer;
      border-radius:12px;
      padding:10px 14px;
      font-weight:900;
      font-size:12px;
      transition:0.15s;
      display:inline-flex;
      align-items:center;
      gap:8px;
      color:#0b1220;
      background: linear-gradient(180deg, rgba(96,165,250,1), rgba(59,130,246,1));
    }

    button:hover{ transform: translateY(-1px); filter:brightness(1.05); }
    button:active{ transform: translateY(0px); filter:brightness(0.98); }

    .btn2{
      background: linear-gradient(180deg, rgba(52,211,153,1), rgba(16,185,129,1));
    }

    .btnDanger{
      background: linear-gradient(180deg, rgba(251,113,133,1), rgba(244,63,94,1));
    }

    .btnGhost{
      background: rgba(15,23,42,0.8);
      border:1px solid var(--border);
      color:var(--text);
    }

    .row{
      display:flex;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
      align-items:center;
    }

    .mono{ font-family:var(--mono); }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:11px;
      color:var(--muted);
      background: rgba(2,6,23,0.4);
      user-select:none;
      font-weight:900;
    }

    .tag.green{ color:rgba(34,197,94,0.95); border-color: rgba(34,197,94,0.25); }
    .tag.red{ color:rgba(251,113,133,0.95); border-color: rgba(251,113,133,0.25); }
    .tag.yellow{ color:rgba(251,191,36,0.95); border-color: rgba(251,191,36,0.25); }
    .tag.blue{ color:rgba(96,165,250,0.95); border-color: rgba(96,165,250,0.25); }

    .divider{
      height:1px;
      background: var(--border);
      margin: 14px 0;
    }

    .listBox{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(2,6,23,0.35);
      overflow:hidden;
    }

    .item{
      padding:12px 12px;
      border-bottom:1px solid var(--border);
      cursor:pointer;
      transition:.12s;
    }
    .item:hover{ background: rgba(255,255,255,0.03); }

    .item:last-child{ border-bottom:none; }

    .inline{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      flex-wrap:wrap;
    }

    .small{
      font-size:11px;
      color:var(--muted);
      line-height:1.4;
    }

    .collapse{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(2,6,23,0.35);
      display:none;
    }

    .toast{
      position: fixed;
      bottom: 20px;
      right: 20px;
      max-width: 360px;
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(17,24,39,0.95);
      box-shadow: var(--shadow);
      color: var(--text);
      font-size: 12px;
      display:none;
      z-index:999;
    }
    .toast strong{
      display:block;
      margin-bottom:6px;
      font-size:12px;
    }

    .clickSource{
      cursor:pointer;
      color: rgba(96,165,250,0.95);
      text-decoration: underline;
    }
    .clickSource:hover{ filter: brightness(1.2); }

    .clickPlayer{
      cursor:pointer;
      color: rgba(52,211,153,0.95);
      text-decoration: underline;
    }
    .clickPlayer:hover{ filter: brightness(1.2); }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
<header>
  <div class="wrap topbar">
    <div>
      <h1>Wankos Intel Panel</h1>
      <div class="subtitle">
        Supabase Tribe DB ‚Ä¢ tylko w≈Çasne wioski w analizie ‚Ä¢ wsp√≥lna powtarzalno≈õƒá atak√≥w
      </div>
    </div>

    <div class="tabs hidden" id="mainTabs">
      <div class="tab active" data-tab="labels">Etykiety</div>
      <div class="tab" data-tab="analysis">Analiza</div>
      <div class="tab" data-tab="enemydb">Baza Token√≥w</div>
      <div class="tab" data-tab="admin">Panel Admina</div>
      <div class="tab" data-tab="settings">Ustawienia</div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">

    <!-- LOGIN -->
    <div class="tabPanel" id="tab-login">
      <div class="card">
        <h2>
          üîê Logowanie / Rejestracja
          <span class="tag blue">Wankos2026</span>
        </h2>

        <div class="hint">
          Za≈Ç√≥≈º konto lub zaloguj siƒô. Nick = nick w grze.<br>
          Rejestracja wymaga kodu plemienia.
        </div>

        <div class="divider"></div>

        <div class="row">
          <input id="loginNick" placeholder="Nick w grze (np. Jupiter)" />
          <input id="loginPass" type="password" placeholder="Has≈Ço" />
        </div>

        <div class="row">
          <button id="btnLogin">Zaloguj</button>
          <button id="btnLogout" class="btnDanger hidden">Wyloguj</button>
        </div>

        <div class="divider"></div>

        <h2>üÜï Rejestracja</h2>
        <div class="row">
          <input id="regNick" placeholder="Nick w grze" />
          <input id="regPass" type="password" placeholder="Has≈Ço" />
          <input id="regTribeCode" placeholder="Kod plemienia (Wankos2026)" />
        </div>

        <div class="row">
          <button id="btnRegister" class="btn2">Za≈Ç√≥≈º konto</button>
        </div>

        <div class="divider"></div>

        <div class="hint">
          Po zalogowaniu etykiety atak√≥w zapisujƒÖ siƒô do bazy plemienia.
        </div>
      </div>
    </div>

    <!-- LABELS -->
    <div class="tabPanel hidden" id="tab-labels">
      <div class="card">
        <h2>
          üè∑Ô∏è Etykiety Atak√≥w
          <span class="tag green" id="userTag">USER</span>
        </h2>

        <div class="hint">
          Wklej etykiety z gry. System automatycznie zapisze je do bazy plemienia.
          Wioski obro≈Ñcy (defender) zostanƒÖ przypisane do Twojego konta.
        </div>

        <textarea id="labelsInput" placeholder="Wklej etykiety tutaj..."></textarea>

        <div class="row">
          <button id="btnUploadLabels" class="btn2">üì• Wy≈õlij do bazy plemienia</button>
          <button id="btnClearLabels" class="btnGhost">üßπ Wyczy≈õƒá</button>
        </div>

        <div class="divider"></div>

        <h2>üìå Podsumowanie</h2>
        <div id="labelsSummary" class="listBox">
          <div class="item small">Brak danych.</div>
        </div>
      </div>
    </div>

    <!-- ANALYSIS -->
    <div class="tabPanel hidden" id="tab-analysis">
      <div class="card">
        <h2>
          üìä Analiza (tylko Twoje wioski)
          <span class="tag yellow">Threat Engine</span>
        </h2>

        <div class="hint">
          Ranking zagro≈ºonych wiosek, ale tylko defender = Twoje konto.<br>
          Powtarzalno≈õƒá ≈∫r√≥de≈Ç jest liczona z ca≈Çej bazy plemienia.
        </div>

        <div class="row">
          <button id="btnRunThreat" class="btn2">‚ö° Przelicz analizƒô</button>
        </div>

        <div id="threatBoard" class="listBox">
          <div class="item small">Brak analizy.</div>
        </div>
      </div>
    </div>

    <!-- ENEMY TOKENS -->
    <div class="tabPanel hidden" id="tab-enemydb">
      <div class="card">
        <h2>
          üè∞ Baza Token√≥w (plemienna)
          <span class="tag blue">Supabase</span>
        </h2>

        <div class="hint">
          To jest wsp√≥lna baza token√≥w plemienia.
        </div>

        <div class="row">
          <input id="enemySearch" placeholder="Szukaj coords (np. 626|471)" class="mono"/>
          <button id="btnEnemySearch">Szukaj</button>
        </div>

        <div id="enemyList" class="listBox"></div>

        <div class="divider"></div>

        <h2>üéØ Profil wioski</h2>
        <div id="enemyProfile" class="listBox">
          <div class="item small">Kliknij wioskƒô aby zobaczyƒá szczeg√≥≈Çy.</div>
        </div>
      </div>
    </div>

    <!-- ADMIN -->
    <div class="tabPanel hidden" id="tab-admin">
      <div class="card">
        <h2>
          üëë Panel Admina
          <span class="tag red">ADMIN ONLY</span>
        </h2>

        <div class="hint">
          Tu admin widzi u≈ºytkownik√≥w i mo≈ºe nadawaƒá admina innym.
        </div>

        <div class="divider"></div>

        <h2>üë• U≈ºytkownicy</h2>
        <div id="adminUsersList" class="listBox">
          <div class="item small">Brak danych.</div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button id="btnRefreshAdmin" class="btn2">üîÑ Od≈õwie≈º listƒô</button>
          <button id="btnDeleteAllLabels" class="btnDanger">üóëÔ∏è Usu≈Ñ WSZYSTKIE etykiety</button>
        </div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div class="tabPanel hidden" id="tab-settings">
      <div class="card">
        <h2>
          ‚öôÔ∏è Ustawienia
          <span class="tag blue">Konto</span>
        </h2>

        <div class="hint">
          Mo≈ºesz usunƒÖƒá tylko swoje etykiety.
        </div>

        <div class="divider"></div>

        <div class="row">
          <button id="btnDeleteMyLabels" class="btnDanger">üóëÔ∏è Usu≈Ñ moje etykiety</button>
        </div>
      </div>
    </div>

  </div>
</main>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ===================== SUPABASE CONFIG ===================== */
const SUPABASE_URL = "https://cixrktawkfxaexhzhnho.supabase.co";
const SUPABASE_KEY = "sb_publishable_kUYmC66z6c9g3qrj0hx2Zg_ZV__s0zA";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const TRIBE_CODE = "Wankos2026";
const SESSION_KEY = "wankos_session_user";

/* ===================== UTIL ===================== */
function toast(title, msg){
  const t = document.getElementById("toast");
  t.innerHTML = `<strong>${escapeHtml(title)}</strong>${escapeHtml(msg)}`;
  t.style.display = "block";
  setTimeout(()=>{ t.style.display="none"; }, 2500);
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

function groupBy(arr, keyFn){
  const m = {};
  for(const item of arr){
    const k = keyFn(item);
    if(!m[k]) m[k] = [];
    m[k].push(item);
  }
  return m;
}

function nowISO(){ return new Date().toISOString(); }

/* ===================== AUTH (LOCAL SESSION) ===================== */
function getSession(){
  try{
    const raw = localStorage.getItem(SESSION_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}

function setSession(user){
  localStorage.setItem(SESSION_KEY, JSON.stringify(user));
}

function clearSession(){
  localStorage.removeItem(SESSION_KEY);
}

function isLoggedIn(){
  return !!getSession();
}

function currentNick(){
  const s = getSession();
  return s ? s.nick : null;
}

function isAdmin(){
  const s = getSession();
  return s ? s.is_admin === true : false;
}

/* ===================== UI ===================== */
function showTabs(){
  document.getElementById("mainTabs").classList.remove("hidden");
  document.getElementById("tab-login").classList.add("hidden");
}

function showLogin(){
  document.getElementById("mainTabs").classList.add("hidden");
  document.getElementById("tab-login").classList.remove("hidden");

  document.querySelectorAll(".tabPanel").forEach(p=>{
    if(p.id !== "tab-login") p.classList.add("hidden");
  });
}

function switchTab(name){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tabPanel").forEach(p=>p.classList.add("hidden"));

  document.querySelector(`.tab[data-tab="${name}"]`).classList.add("active");
  document.getElementById("tab-"+name).classList.remove("hidden");

  if(name === "analysis") renderThreatBoard();
  if(name === "enemydb") renderEnemyDB();
  if(name === "admin") renderAdminUsers();
}

/* ===================== PARSER ETYKIET ===================== */
function parseEnemyLabels(text){
  const lines = text.split("\n").map(x=>x.trim()).filter(Boolean);
  const attacks = [];

  let currentDefender = null;

  for(const line of lines){

    const villageMatch = line.match(/\[b\]Wioska:\[\/b\]\s*\[coord\](\d{1,3}\|\d{1,3})\[\/coord\]/);
    if(villageMatch){
      currentDefender = villageMatch[1];
      continue;
    }

    if(!line.includes("[command]attack[/command]")) continue;

    const coordsMatches = [...line.matchAll(/\[coord\](\d{1,3}\|\d{1,3})\[\/coord\]/g)].map(m=>m[1]);
    const source = coordsMatches.length > 0 ? coordsMatches[0] : null;

    const playerMatch = line.match(/\[player\](.*?)\[\/player\]/);
    const player = playerMatch ? playerMatch[1] : "UNKNOWN";

    const arrivalMatch = line.match(/Czas przybycia:\s*(\d{2}\.\d{2}\.\d{2}\s+\d{2}:\d{2}:\d{2})/);
    const arrival = arrivalMatch ? arrivalMatch[1] : null;

    attacks.push({
      defender: currentDefender,
      source,
      player,
      arrival,
      raw: line
    });
  }

  return attacks;
}

/* ===================== SUPABASE DB OPS ===================== */
async function supaLogin(nick, pass){
  const { data, error } = await supabase
    .from("users")
    .select("*")
    .eq("nick", nick)
    .eq("password", pass)
    .limit(1);

  if(error) throw error;
  if(!data || data.length === 0) return null;
  return data[0];
}

async function supaRegister(nick, pass){
  const { data, error } = await supabase
    .from("users")
    .insert([{ nick, password: pass, is_admin: false }])
    .select()
    .limit(1);

  if(error) throw error;
  return data[0];
}

async function supaUploadLabels(labels){
  const nick = currentNick();
  const rows = labels.map(a=>({
    owner_nick: nick,
    defender: a.defender,
    source: a.source,
    player: a.player,
    arrival: a.arrival,
    raw: a.raw
  }));

  const { error } = await supabase.from("attack_labels").insert(rows);
  if(error) throw error;
}

async function supaGetMyLabels(){
  const nick = currentNick();
  const { data, error } = await supabase
    .from("attack_labels")
    .select("*")
    .eq("owner_nick", nick);

  if(error) throw error;
  return data || [];
}

async function supaGetAllLabels(){
  const { data, error } = await supabase
    .from("attack_labels")
    .select("*");

  if(error) throw error;
  return data || [];
}

async function supaDeleteMyLabels(){
  const nick = currentNick();
  const { error } = await supabase
    .from("attack_labels")
    .delete()
    .eq("owner_nick", nick);

  if(error) throw error;
}

async function supaDeleteAllLabels(){
  const { error } = await supabase
    .from("attack_labels")
    .delete()
    .neq("owner_nick", "___never___");

  if(error) throw error;
}

async function supaGetUsers(){
  const { data, error } = await supabase
    .from("users")
    .select("*")
    .order("created_at", { ascending: true });

  if(error) throw error;
  return data || [];
}

async function supaSetAdmin(nick, val){
  const { error } = await supabase
    .from("users")
    .update({ is_admin: val })
    .eq("nick", nick);

  if(error) throw error;
}

/* ===================== ANALYSIS ===================== */
function computeSourceRepeatability(allAttacks){
  const bySource = groupBy(allAttacks.filter(a=>a.source), a=>a.source);
  const map = {};
  for(const s in bySource){
    map[s] = bySource[s].length;
  }
  return map;
}

async function renderThreatBoard(){
  const board = document.getElementById("threatBoard");
  board.innerHTML = `<div class="item small">‚è≥ Pobieranie danych z Supabase...</div>`;

  try{
    const myLabels = await supaGetMyLabels();
    const allLabels = await supaGetAllLabels();

    if(myLabels.length === 0){
      board.innerHTML = `<div class="item small">Brak Twoich etykiet w bazie.</div>`;
      return;
    }

    const repeatMap = computeSourceRepeatability(allLabels);

    const byDef = groupBy(myLabels.filter(a=>a.defender), a=>a.defender);
    const defenders = Object.keys(byDef);

    const results = defenders.map(def=>{
      const attacks = byDef[def];
      const uniqueSources = [...new Set(attacks.map(a=>a.source).filter(Boolean))];

      let score = 0;
      score += Math.min(60, attacks.length * 6);
      score += Math.min(40, uniqueSources.length * 7);

      const maxRepeat = Math.max(0, ...uniqueSources.map(s => repeatMap[s] || 0));
      if(maxRepeat >= 6) score += 15;
      if(maxRepeat >= 12) score += 20;

      score = Math.max(0, Math.min(100, score));

      let verdict = "LOW";
      if(score >= 80) verdict = "CRITICAL";
      else if(score >= 55) verdict = "HIGH";
      else if(score >= 30) verdict = "MEDIUM";

      return { defender:def, attacks, score, verdict, maxRepeat };
    });

    results.sort((a,b)=> b.score - a.score);

    let html = "";
    for(const r of results){
      const color = r.verdict === "CRITICAL" ? "red" :
                    r.verdict === "HIGH" ? "yellow" :
                    r.verdict === "MEDIUM" ? "yellow" : "green";

      html += `
        <div class="item" data-def="${r.defender}">
          <div class="inline">
            <div>
              <div class="mono" style="font-weight:900;">${r.defender}</div>
              <div class="small">
                Atak√≥w: <b class="mono">${r.attacks.length}</b>
                ‚Ä¢ ≈πr√≥de≈Ç: <b class="mono">${new Set(r.attacks.map(x=>x.source)).size}</b>
                ‚Ä¢ Max repeat: <b class="mono">${r.maxRepeat}</b>
              </div>
            </div>
            <span class="tag ${color}">${r.verdict} ${Math.round(r.score)}%</span>
          </div>

          <div class="collapse"></div>
        </div>
      `;
    }

    board.innerHTML = html;

    board.querySelectorAll("[data-def]").forEach(item=>{
      item.addEventListener("click", ()=>{
        const def = item.getAttribute("data-def");
        const collapse = item.querySelector(".collapse");

        if(collapse.style.display === "block"){
          collapse.style.display = "none";
          collapse.innerHTML = "";
          return;
        }

        const list = byDef[def];

        const attacksHtml = list.map(a=>{
          const src = a.source || "???";
          const rep = repeatMap[src] || 1;

          return `
            <div style="padding:10px;border-bottom:1px solid var(--border);">
              <div class="mono">
                <b class="clickSource" data-src="${src}">${src}</b> ‚Üí <b>${def}</b>
              </div>
              <div class="small">
                Gracz: <b class="clickPlayer" data-player="${escapeHtml(a.player||"UNKNOWN")}">${escapeHtml(a.player||"UNKNOWN")}</b>
                ‚Ä¢ Przybycie: <span class="mono">${a.arrival||"??"}</span>
              </div>
              <div class="small">
                Powtarzalno≈õƒá tej wioski w ca≈Çym plemieniu: <b class="mono">${rep}</b>
              </div>
              <div class="small mono" style="opacity:.65;margin-top:6px;">${escapeHtml(a.raw)}</div>
            </div>
          `;
        }).join("");

        collapse.innerHTML = attacksHtml;
        collapse.style.display = "block";

        collapse.querySelectorAll(".clickPlayer").forEach(el=>{
          el.addEventListener("click", (e)=>{
            e.stopPropagation();

            const player = el.getAttribute("data-player");
            const playerAttacks = allLabels.filter(x => (x.player||"UNKNOWN") === player);
            const byVillage = groupBy(playerAttacks.filter(x=>x.source), x=>x.source);

            let html = `
              <div style="padding:10px;border-bottom:1px solid var(--border);">
                <div class="mono" style="font-weight:900;">Gracz: ${escapeHtml(player)}</div>
                <div class="small">≈ÅƒÖcznie atak√≥w w plemieniu: <b class="mono">${playerAttacks.length}</b></div>
              </div>
            `;

            const villages = Object.keys(byVillage).sort((a,b)=> byVillage[b].length - byVillage[a].length);
            for(const v of villages){
              html += `
                <div class="item" style="border-bottom:1px solid var(--border);">
                  <div class="inline">
                    <div class="mono"><b>${v}</b></div>
                    <span class="tag blue">${byVillage[v].length} atak√≥w</span>
                  </div>
                </div>
              `;
            }

            collapse.innerHTML = html;
          });
        });

      });
    });

  }catch(e){
    board.innerHTML = `<div class="item small">‚ùå B≈ÇƒÖd: ${escapeHtml(e.message)}</div>`;
  }
}

/* ===================== ADMIN PANEL ===================== */
async function renderAdminUsers(){
  const box = document.getElementById("adminUsersList");

  if(!isAdmin()){
    box.innerHTML = `<div class="item small">Brak uprawnie≈Ñ.</div>`;
    return;
  }

  box.innerHTML = `<div class="item small">‚è≥ Pobieranie u≈ºytkownik√≥w...</div>`;

  try{
    const users = await supaGetUsers();

    let html = "";
    for(const u of users){
      const tag = u.is_admin ? `<span class="tag green">ADMIN</span>` : `<span class="tag blue">USER</span>`;

      html += `
        <div class="item" data-user="${u.nick}">
          <div class="inline">
            <div>
              <div class="mono"><b class="clickPlayer" data-player="${escapeHtml(u.nick)}">${escapeHtml(u.nick)}</b></div>
              <div class="small">Utworzono: ${new Date(u.created_at).toLocaleString()}</div>
            </div>
            ${tag}
          </div>
        </div>
      `;
    }

    box.innerHTML = html;

    box.querySelectorAll("[data-user]").forEach(el=>{
      el.addEventListener("click", async ()=>{
        const nick = el.getAttribute("data-user");

        if(nick === currentNick()){
          toast("Admin", "Nie mo≈ºesz zmieniaƒá swoich uprawnie≈Ñ tutaj.");
          return;
        }

        const makeAdmin = confirm(`Nadaƒá ADMIN dla ${nick}? (OK=TAK, Cancel=Zabierz admina)`);
        await supaSetAdmin(nick, makeAdmin);

        toast("Admin", makeAdmin ? `Nadano ADMIN dla ${nick}` : `Zabrano ADMIN dla ${nick}`);
        renderAdminUsers();
      });
    });

  }catch(e){
    box.innerHTML = `<div class="item small">‚ùå B≈ÇƒÖd: ${escapeHtml(e.message)}</div>`;
  }
}

/* ===================== TOKENS (PLACEHOLDER) ===================== */
async function renderEnemyDB(){
  document.getElementById("enemyList").innerHTML =
    `<div class="item small">Tokeny bƒôdƒÖ dodane w kolejnym kroku (na razie skupiamy siƒô na etykietach).</div>`;
}

function renderEnemyProfile(coords){
  document.getElementById("enemyProfile").innerHTML =
    `<div class="item small">Profil token√≥w jeszcze nie jest aktywny.</div>`;
}

/* ===================== EVENTS ===================== */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=> switchTab(tab.getAttribute("data-tab")));
});

document.getElementById("btnClearLabels").addEventListener("click", ()=>{
  document.getElementById("labelsInput").value = "";
  document.getElementById("labelsSummary").innerHTML = `<div class="item small">Brak danych.</div>`;
});

/* LOGIN */
document.getElementById("btnLogin").addEventListener("click", async ()=>{
  const nick = document.getElementById("loginNick").value.trim();
  const pass = document.getElementById("loginPass").value.trim();

  if(!nick || !pass){
    toast("Logowanie", "Podaj nick i has≈Ço.");
    return;
  }

  try{
    const user = await supaLogin(nick, pass);
    if(!user){
      toast("Logowanie", "B≈Çƒôdny nick lub has≈Ço.");
      return;
    }

    setSession(user);

    toast("Logowanie", `Zalogowano jako ${user.nick}`);
    bootAfterLogin();

  }catch(e){
    toast("B≈ÇƒÖd", e.message);
  }
});

/* REGISTER */
document.getElementById("btnRegister").addEventListener("click", async ()=>{
  const nick = document.getElementById("regNick").value.trim();
  const pass = document.getElementById("regPass").value.trim();
  const code = document.getElementById("regTribeCode").value.trim();

  if(!nick || !pass){
    toast("Rejestracja", "Podaj nick i has≈Ço.");
    return;
  }

  if(code !== TRIBE_CODE){
    toast("Rejestracja", "Z≈Çy kod plemienia.");
    return;
  }

  try{
    const user = await supaRegister(nick, pass);
    toast("Rejestracja", `Konto utworzone: ${user.nick}`);
  }catch(e){
    toast("B≈ÇƒÖd", e.message);
  }
});

/* LOGOUT */
document.getElementById("btnLogout").addEventListener("click", ()=>{
  clearSession();
  toast("Wylogowano", "Sesja usuniƒôta.");
  location.reload();
});

/* UPLOAD LABELS */
document.getElementById("btnUploadLabels").addEventListener("click", async ()=>{
  const text = document.getElementById("labelsInput").value;
  const parsed = parseEnemyLabels(text);

  if(parsed.length === 0){
    toast("Etykiety", "Nie wykryto atak√≥w.");
    return;
  }

  try{
    await supaUploadLabels(parsed);

    const byDef = groupBy(parsed, x=>x.defender);
    let html = "";

    for(const def in byDef){
      html += `
        <div class="item">
          <div class="inline">
            <div>
              <div class="mono"><b>${def}</b></div>
              <div class="small">Dodano atak√≥w: <b class="mono">${byDef[def].length}</b></div>
            </div>
            <span class="tag green">OK</span>
          </div>
        </div>
      `;
    }

    document.getElementById("labelsSummary").innerHTML = html;
    toast("Etykiety", `Wys≈Çano do bazy: ${parsed.length}`);

  }catch(e){
    toast("B≈ÇƒÖd", e.message);
  }
});

/* RUN ANALYSIS */
document.getElementById("btnRunThreat").addEventListener("click", ()=>{
  renderThreatBoard();
});

/* SETTINGS - DELETE MY LABELS */
document.getElementById("btnDeleteMyLabels").addEventListener("click", async ()=>{
  if(!confirm("UsunƒÖƒá wszystkie Twoje etykiety z bazy?")) return;

  try{
    await supaDeleteMyLabels();
    toast("Ustawienia", "Usuniƒôto Twoje etykiety.");
  }catch(e){
    toast("B≈ÇƒÖd", e.message);
  }
});

/* ADMIN DELETE ALL */
document.getElementById("btnDeleteAllLabels").addEventListener("click", async ()=>{
  if(!isAdmin()){
    toast("Admin", "Brak uprawnie≈Ñ.");
    return;
  }

  if(!confirm("UsunƒÖƒá WSZYSTKIE etykiety ca≈Çego plemienia?")) return;

  try{
    await supaDeleteAllLabels();
    toast("Admin", "Usuniƒôto ca≈ÇƒÖ bazƒô etykiet.");
  }catch(e){
    toast("B≈ÇƒÖd", e.message);
  }
});

/* ADMIN REFRESH */
document.getElementById("btnRefreshAdmin").addEventListener("click", ()=>{
  renderAdminUsers();
});

/* ===================== INIT ===================== */
function bootAfterLogin(){
  showTabs();

  const tag = document.getElementById("userTag");
  tag.textContent = currentNick();
  tag.className = isAdmin() ? "tag red" : "tag green";

  document.getElementById("btnLogout").classList.remove("hidden");

  // admin tab only if admin
  if(!isAdmin()){
    document.querySelector('.tab[data-tab="admin"]').classList.add("hidden");
  }else{
    document.querySelector('.tab[data-tab="admin"]').classList.remove("hidden");
  }

  switchTab("labels");
}

(function init(){
  if(isLoggedIn()){
    bootAfterLogin();
  }else{
    showLogin();
  }
})();
</script>

</body>
</html>
